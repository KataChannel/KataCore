#!/bin/bash

# KataCore Deployment Manager
# Script tổng hợp để quản lý deployment với đầy đủ tính năng hỗ trợ

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
PURPLE='\033[0;35m'
NC='\033[0m'

log() { echo -e "${BLUE}[$(date +'%H:%M:%S')]${NC} $1"; }
success() { echo -e "${GREEN}✅ $1${NC}"; }
warning() { echo -e "${YELLOW}⚠️  $1${NC}"; }
error() { echo -e "${RED}❌ $1${NC}"; exit 1; }
info() { echo -e "${CYAN}ℹ️  $1${NC}"; }

# Banner
show_banner() {
    clear
    echo -e "${PURPLE}"
    echo "╔══════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════╗"
    echo "║  ██╗  ██╗ █████╗ ████████╗ █████╗  ██████╗ ██████╗ ██████╗ ███████╗                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ║"
    echo "║  ██║ ██╔╝██╔══██╗╚══██╔══╝██╔══██╗██╔════╝██╔═══██╗██╔══██╗██╔════╝                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ║"
    echo "║  █████╔╝ ███████║   ██║   ███████║██║     ██║   ██║██████╔╝█████╗                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ║"
    echo "║  ██╔═██╗ ██╔══██║   ██║   ██╔══██║██║     ██║   ██║██╔══██╗██╔══╝                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ║"
    echo "║  ██║  ██╗██║  ██║   ██║   ██║  ██║╚██████╗╚██████╔╝██║  ██║███████╗                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ║"
    echo "║  ╚═╝  ╚═╝╚═╝  ╚═╝   ╚═╝   ╚═╝  ╚═╝ ╚═════╝ ╚═════╝ ╚═╝  ╚═╝╚══════╝                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ║"
    echo "║                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ║"
    echo "║                           🚀 DEPLOYMENT MANAGER - Quản lý deploy hoàn toàn tự động                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ║"
    echo "║                           ✨ Deploy lên bất kỳ server nào với hỗ trợ xử lý lỗi thông minh                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ║"
    echo "╚══════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════╝"
    echo -e "${NC}"
}

# Main menu
show_main_menu() {
    echo -e "${CYAN}🎯 Chọn chức năng:${NC}"
    echo ""
    echo "1. 🚀 Deploy Ứng Dụng"
    echo "2. 🔧 Quản Lý Server"
    echo "3. 🛠️  Troubleshooting"
    echo "4. 📊 Monitoring & Logs"
    echo "5. ⚙️  Cấu Hình"
    echo "6. ❓ Hướng Dẫn"
    echo "7. ❌ Thoát"
    echo ""
    read -p "Nhập lựa chọn (1-7): " choice
    
    case $choice in
        1) deploy_menu ;;
        2) server_menu ;;
        3) troubleshoot_menu ;;
        4) monitoring_menu ;;
        5) config_menu ;;
        6) help_menu ;;
        7) echo "Tạm biệt!"; exit 0 ;;
        *) warning "Lựa chọn không hợp lệ"; sleep 2; main_loop ;;
    esac
}

# Deploy menu
deploy_menu() {
    clear
    show_banner
    echo -e "${CYAN}🚀 Deploy Ứng Dụng${NC}"
    echo "════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════"
    echo ""
    echo "1. 🎯 Deploy Tự Động (Recommended)"
    echo "2. 🔧 Deploy Thủ Công"
    echo "3. 📋 Danh Sách Server Đã Lưu"
    echo "4. ➕ Thêm Server Mới"
    echo "5. 🔙 Quay Lại"
    echo ""
    read -p "Chọn (1-5): " choice
    
    case $choice in
        1) 
            ./universal-deployer.sh
            ;;
        2) 
            read -p "Nhập IP/Domain server: " host
            read -p "Nhập SSH user [root]: " user
            read -p "Nhập SSH port [22]: " port
            user=${user:-root}
            port=${port:-22}
            ./universal-deployer.sh --host "$host" --user "$user" --port "$port"
            ;;
        3) 
            ./deploy-helper.sh list
            ;;
        4) 
            ./deploy-helper.sh add
            ;;
        5) 
            main_loop
            ;;
        *) 
            warning "Lựa chọn không hợp lệ"; sleep 2; deploy_menu
            ;;
    esac
    
    echo ""
    read -p "Nhấn Enter để tiếp tục..."
    main_loop
}

# Server management menu
server_menu() {
    clear
    show_banner
    echo -e "${CYAN}🔧 Quản Lý Server${NC}"
    echo "════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════"
    echo ""
    echo "1. 📊 Kiểm Tra Trạng Thái Server"
    echo "2. 🧹 Dọn Dẹp Deployment"
    echo "3. 🔄 Restart Services"
    echo "4. 📋 Xem Logs"
    echo "5. 🔐 SSH Vào Server"
    echo "6. 🔙 Quay Lại"
    echo ""
    read -p "Chọn (1-6): " choice
    
    case $choice in
        1) 
            read -p "Nhập tên server đã lưu hoặc IP: " server
            if ./deploy-helper.sh list | grep -q "$server"; then
                ./deploy-helper.sh status "$server"
            else
                ./troubleshoot.sh check-server "$server"
            fi
            ;;
        2) 
            read -p "Nhập tên server: " server
            ./troubleshoot.sh clean "$server"
            ;;
        3) 
            read -p "Nhập tên server: " server
            ./deploy-helper.sh deploy "$server"
            ;;
        4) 
            read -p "Nhập tên server: " server
            ./deploy-helper.sh logs "$server"
            ;;
        5) 
            read -p "Nhập tên server: " server
            ./deploy-helper.sh ssh "$server"
            ;;
        6) 
            main_loop
            ;;
        *) 
            warning "Lựa chọn không hợp lệ"; sleep 2; server_menu
            ;;
    esac
    
    echo ""
    read -p "Nhấn Enter để tiếp tục..."
    main_loop
}

# Troubleshooting menu
troubleshoot_menu() {
    clear
    show_banner
    echo -e "${CYAN}🛠️  Troubleshooting${NC}"
    echo "════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════"
    echo ""
    echo "1. 🔍 Kiểm Tra Môi Trường Local"
    echo "2. 🔐 Test Kết Nối SSH"
    echo "3. 🖥️  Kiểm Tra Yêu Cầu Server"
    echo "4. 🔧 Sửa Lỗi Thường Gặp"
    echo "5. 🧹 Dọn Dẹp Toàn Bộ"
    echo "6. 🔙 Quay Lại"
    echo ""
    read -p "Chọn (1-6): " choice
    
    case $choice in
        1) 
            ./troubleshoot.sh check-local
            ;;
        2) 
            read -p "Nhập IP/Domain server: " host
            ./troubleshoot.sh ssh-test "$host"
            ;;
        3) 
            read -p "Nhập IP/Domain server: " host
            ./troubleshoot.sh check-server "$host"
            ;;
        4) 
            read -p "Nhập IP/Domain server: " host
            ./troubleshoot.sh fix-issues "$host"
            ;;
        5) 
            read -p "Nhập IP/Domain server: " host
            ./troubleshoot.sh clean "$host"
            ;;
        6) 
            main_loop
            ;;
        *) 
            warning "Lựa chọn không hợp lệ"; sleep 2; troubleshoot_menu
            ;;
    esac
    
    echo ""
    read -p "Nhấn Enter để tiếp tục..."
    main_loop
}

# Monitoring menu
monitoring_menu() {
    clear
    show_banner
    echo -e "${CYAN}📊 Monitoring & Logs${NC}"
    echo "════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════"
    echo ""
    echo "1. 📋 Xem Logs Realtime"
    echo "2. 📊 Trạng Thái Services"
    echo "3. 📈 Lịch Sử Deploy"
    echo "4. 💾 Backup Logs"
    echo "5. 🔙 Quay Lại"
    echo ""
    read -p "Chọn (1-5): " choice
    
    case $choice in
        1) 
            read -p "Nhập tên server: " server
            read -p "Service cụ thể (để trống = tất cả): " service
            ./troubleshoot.sh logs "$server" "$service"
            ;;
        2) 
            read -p "Nhập tên server: " server
            ./deploy-helper.sh status "$server"
            ;;
        3) 
            read -p "Nhập tên server: " server
            ssh $(./deploy-helper.sh list | grep "$server" | awk '{print $2}') "cd /opt/katacore && cat .deploy-cache/deployment-history.log 2>/dev/null || echo 'No history found'"
            ;;
        4) 
            log "Backup logs feature coming soon..."
            ;;
        5) 
            main_loop
            ;;
        *) 
            warning "Lựa chọn không hợp lệ"; sleep 2; monitoring_menu
            ;;
    esac
    
    echo ""
    read -p "Nhấn Enter để tiếp tục..."
    main_loop
}

# Configuration menu
config_menu() {
    clear
    show_banner
    echo -e "${CYAN}⚙️  Cấu Hình${NC}"
    echo "════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════"
    echo ""
    echo "1. 📝 Tạo .env.prod.example Template"
    echo "2. 🔐 Tạo SSH Key"
    echo "3. 🛠️  Cấu Hình Docker Compose"
    echo "4. 🌐 Cấu Hình Nginx"
    echo "5. 📋 Quản Lý Server List"
    echo "6. 🔙 Quay Lại"
    echo ""
    read -p "Chọn (1-6): " choice
    
    case $choice in
        1) 
            read -p "Nhập domain [yourdomain.com]: " domain
            domain=${domain:-yourdomain.com}
            ./universal-deployer.sh --create-env-template --domain "$domain"
            ;;
        2) 
            if [[ ! -f ~/.ssh/id_rsa ]]; then
                ssh-keygen -t rsa -b 4096 -C "katacore-deploy" -f ~/.ssh/id_rsa -N ""
                success "SSH key created"
            else
                info "SSH key already exists"
            fi
            echo "Public key:"
            cat ~/.ssh/id_rsa.pub
            ;;
        3) 
            info "Opening docker-compose.yml for editing..."
            ${EDITOR:-nano} docker-compose.yml
            ;;
        4) 
            info "Opening nginx config for editing..."
            mkdir -p nginx/conf.d
            ${EDITOR:-nano} nginx/conf.d/katacore.conf
            ;;
        5) 
            ./deploy-helper.sh list
            echo ""
            echo "Các lệnh quản lý:"
            echo "  ./deploy-helper.sh add     - Thêm server"
            echo "  ./deploy-helper.sh remove  - Xóa server"
            ;;
        6) 
            main_loop
            ;;
        *) 
            warning "Lựa chọn không hợp lệ"; sleep 2; config_menu
            ;;
    esac
    
    echo ""
    read -p "Nhấn Enter để tiếp tục..."
    main_loop
}

# Help menu
help_menu() {
    clear
    show_banner
    echo -e "${CYAN}❓ Hướng Dẫn Sử Dụng${NC}"
    echo "════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════"
    echo ""
    echo -e "${GREEN}📚 Quy Trình Deploy Cơ Bản:${NC}"
    echo ""
    echo "1. 🔧 Chuẩn bị server:"
    echo "   - Ubuntu/Debian/CentOS với SSH access"
    echo "   - Minimum 2GB RAM, 20GB disk"
    echo "   - Port 22, 80, 443, 3000, 3001 mở"
    echo ""
    echo "2. 🔐 Cấu hình SSH:"
    echo "   - Tạo SSH key: ssh-keygen -t rsa"
    echo "   - Copy key: ssh-copy-id user@server"
    echo "   - Hoặc thêm vào ~/.ssh/authorized_keys"
    echo ""
    echo "3. 🚀 Deploy:"
    echo "   - Chạy script này: ./deploy-manager.sh"
    echo "   - Chọn '1. Deploy Ứng Dụng'"
    echo "   - Chọn '1. Deploy Tự Động'"
    echo "   - Nhập thông tin server"
    echo ""
    echo "4. 📊 Kiểm tra:"
    echo "   - Frontend: http://server-ip:3000"
    echo "   - API: http://server-ip:3001"
    echo "   - Admin: http://server-ip:8080"
    echo ""
    echo -e "${YELLOW}🔧 Các Script Tiện Ích:${NC}"
    echo ""
    echo "- ./universal-deployer.sh  - Deploy chính"
    echo "- ./deploy-helper.sh       - Quản lý server nhanh"
    echo "- ./troubleshoot.sh        - Chẩn đoán & sửa lỗi"
    echo "- ./deploy-manager.sh      - Menu tổng hợp (script này)"
    echo ""
    echo -e "${RED}⚠️  Lưu Ý Quan Trọng:${NC}"
    echo ""
    echo "- Luôn backup dữ liệu trước khi deploy"
    echo "- Kiểm tra kết nối mạng và SSH"
    echo "- Đảm bảo server có đủ tài nguyên"
    echo "- Check logs nếu có lỗi: ./deploy-helper.sh logs server-name"
    echo ""
    echo -e "${CYAN}🆘 Hỗ Trợ Thêm:${NC}"
    echo ""
    echo "- Troubleshooting: ./troubleshoot.sh"
    echo "- Check server: ./troubleshoot.sh check-server IP"
    echo "- Fix issues: ./troubleshoot.sh fix-issues IP"
    echo "- Clean deploy: ./troubleshoot.sh clean IP"
    echo ""
    
    read -p "Nhấn Enter để tiếp tục..."
    main_loop
}

# Main loop
main_loop() {
    show_banner
    show_main_menu
}

# Check if running for first time
first_time_setup() {
    if [[ ! -f ".deploy-manager-setup" ]]; then
        log "🎉 Chào mừng bạn đến với KataCore Deployment Manager!"
        echo ""
        info "Đây là lần đầu tiên bạn chạy script này."
        info "Hệ thống sẽ kiểm tra các yêu cầu cơ bản..."
        echo ""
        
        # Check prerequisites
        ./troubleshoot.sh check-local
        
        echo ""
        success "Thiết lập hoàn tất!"
        touch .deploy-manager-setup
        echo ""
        read -p "Nhấn Enter để tiếp tục..."
    fi
}

# Make sure all scripts are executable
chmod +x universal-deployer.sh deploy-helper.sh troubleshoot.sh

# Main execution
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    first_time_setup
    main_loop
fi
