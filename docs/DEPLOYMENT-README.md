# üöÄ KataCore Deployment Guide

Complete guide for deploying KataCore using the automated deployment scripts.

## üìã Table of Contents

- [üõ†Ô∏è Prerequisites](#-prerequisites)
- [üöÄ Quick Deployment](#-quick-deployment)
- [üìú Available Scripts](#-available-scripts)
- [üîß Configuration](#-configuration)
- [üìù Usage Examples](#-usage-examples)
- [üîç Troubleshooting](#-troubleshooting)
- [üìä Monitoring](#-monitoring)

---

## üõ†Ô∏è Prerequisites

### Server Requirements
- **OS**: Ubuntu 20.04+ or CentOS 8+
- **RAM**: Minimum 2GB (Recommended 4GB+)
- **Storage**: Minimum 20GB free space
- **Network**: Public IP with ports 80, 443, 22 accessible

### Local Requirements
- **SSH Access**: Private key for server access
- **Git**: For code management
- **Docker**: Optional for local testing

### Required Ports
```bash
22    # SSH Access
80    # HTTP (redirects to HTTPS)
443   # HTTPS
3000  # Frontend Application
3001  # Backend API
5432  # PostgreSQL Database
6379  # Redis Cache
9000  # MinIO Storage
9001  # MinIO Console
5050  # pgAdmin (Database Management)
```

---

## üöÄ Quick Deployment

### Method 1: Interactive Mode (Recommended for beginners)
```bash
# Make scripts executable
chmod +x deploy-remote.sh autopush.sh

# Start interactive deployment
./deploy-remote.sh --interactive
```

### Method 2: Direct Deployment
```bash
# Full deployment with SSL
./deploy-remote.sh 116.118.48.143 yourdomain.com

# Simple deployment (IP only, no SSL)
./deploy-remote.sh --simple 116.118.48.143 yourdomain.com
```

### Method 3: Production Deployment
```bash
# Production deployment with all services
./deploy-production.sh 116.118.48.143 yourdomain.com
```

---

## üìú Available Scripts

### 1. `deploy-remote.sh` - Main Deployment Script

**Purpose**: Primary deployment script with full customization options.

**Features**:
- ‚úÖ Dynamic main branch detection
- ‚úÖ Interactive mode for beginners
- ‚úÖ SSL certificate automation
- ‚úÖ Service configuration
- ‚úÖ Environment management
- ‚úÖ Health checks

**Usage**:
```bash
./deploy-remote.sh [OPTIONS] [IP] [DOMAIN]
```

**Options**:
```bash
-i, --interactive    # Interactive mode (recommended)
--user USER         # SSH user (default: root)
--key PATH          # SSH private key path
--simple            # Simple deployment (no SSL)
--force-regen       # Force regenerate environment files
--compose FILE      # Docker compose file selection
--project NAME      # Project name (default: katacore)
--cleanup           # Cleanup deployment on remote server

# Service Options
--install-api       # Install API service
--install-postgres  # Install PostgreSQL database
--install-redis     # Install Redis cache
--install-minio     # Install MinIO object storage
--install-pgadmin   # Install pgAdmin management

# Nginx Options (for full deployment)
--nginxapi          # Enable API subdomain
--nginxpgadmin      # Enable pgAdmin subdomain
--nginxminio        # Enable MinIO subdomain
```

### 2. `autopush.sh` - Git Automation Script

**Purpose**: Automates Git operations with smart commit messages and branch management.

**Features**:
- ‚úÖ Dynamic main branch detection (main/master/develop/dev)
- ‚úÖ Smart commit message generation
- ‚úÖ Merge to main functionality
- ‚úÖ Branch cleanup options
- ‚úÖ Auto-detection of file changes

**Usage**:
```bash
./autopush.sh [OPTIONS] [COMMIT_MESSAGE]
```

**Options**:
```bash
--merge              # Merge current branch to main/master
--main-branch NAME   # Specify main branch name (auto-detect)
--help, -h           # Show help message
```

---

## üîß Configuration

### Environment Variables

The deployment script automatically generates a `.env.prod` file with the following structure:

```bash
# Application Configuration
NODE_ENV=production
API_VERSION=latest
SITE_VERSION=latest
RESTART_POLICY=unless-stopped

# Port Configuration
PORT=3000
SITE_PORT=3000
API_PORT=3001

# Database Configuration
POSTGRES_DB=katacore
POSTGRES_USER=katacore
POSTGRES_PASSWORD=<auto-generated>
DATABASE_URL=postgresql://katacore:<password>@postgres:5432/katacore

# Redis Configuration
REDIS_PASSWORD=<auto-generated>
REDIS_URL=redis://:<password>@redis:6379

# Authentication & Security
JWT_SECRET=<auto-generated>
ENCRYPTION_KEY=<auto-generated>
LOG_LEVEL=info

# MinIO Configuration
MINIO_ROOT_USER=admin
MINIO_ROOT_PASSWORD=<auto-generated>
MINIO_PORT=9000
MINIO_CONSOLE_PORT=9001

# Server Configuration
SERVER_IP=<your-server-ip>
DOMAIN=<your-domain>
DEPLOY_TYPE=<full|simple>

# SSL Configuration (for full deployment)
SSL_EMAIL=admin@<your-domain>
```

### SSH Configuration

The scripts support multiple SSH key configurations:

```bash
# Default locations (auto-detected)
~/.ssh/id_rsa       # Standard SSH key
~/.ssh/id_ed25519   # Ed25519 key
~/.ssh/default      # Custom default key

# Custom key specification
./deploy-remote.sh --key ~/.ssh/my-custom-key.pem 116.118.48.143 domain.com
```

---

## üìù Usage Examples

### Basic Deployments

#### 1. Full Production Deployment
```bash
# With domain and SSL
./deploy-remote.sh 116.118.48.143 mydomain.com

# Interactive mode (recommended for first-time)
./deploy-remote.sh --interactive
```

#### 2. Simple Development Deployment
```bash
# IP only, no SSL
./deploy-remote.sh --simple 192.168.1.100 test.local

# With specific services
./deploy-remote.sh --simple --install-api --install-postgres 192.168.1.100
```

#### 3. Custom SSH Configuration
```bash
# Ubuntu server with custom key
./deploy-remote.sh --user ubuntu --key ~/.ssh/aws-key.pem 54.123.45.67 myapp.com

# Custom project name
./deploy-remote.sh --project myproject --user ubuntu 54.123.45.67 myproject.com
```

### Git Automation Examples

#### 1. Regular Development Workflow
```bash
# Auto-commit and push to current branch
./autopush.sh

# With custom commit message
./autopush.sh "feat: add user authentication system"

# Auto-generated commit message
./autopush.sh
# Output: "update: Improve 3 files (ts js css)"
```

#### 2. Branch Management
```bash
# Merge current branch to main
./autopush.sh --merge

# Merge with custom message
./autopush.sh --merge "release: version 2.1.0"

# Merge to specific branch
./autopush.sh --main-branch develop --merge
```

#### 3. Smart Commit Messages
The script automatically generates meaningful commit messages based on your changes:

```bash
# Examples of auto-generated messages:
"feat: Add 5 new files (tsx ts scss)"
"update: Improve 3 files (js css)"
"refactor: Major updates to 8 files (ts tsx)"
"refactor: Remove 2 files and update 4 files"
"chore: Project maintenance and cleanup"
```

### Advanced Deployments

#### 1. Multi-Service Deployment
```bash
./deploy-remote.sh \
  --install-api \
  --install-postgres \
  --install-redis \
  --install-minio \
  --install-pgadmin \
  --nginxapi \
  --nginxpgadmin \
  116.118.48.143 myapp.com
```

#### 2. Staging Environment
```bash
./deploy-remote.sh \
  --project myapp-staging \
  --compose docker-compose.staging.yml \
  --user ubuntu \
  192.168.1.200 staging.myapp.com
```

#### 3. Force Environment Regeneration
```bash
# Regenerate all environment files
./deploy-remote.sh --force-regen 116.118.48.143 myapp.com
```

### Cleanup and Maintenance

#### 1. Complete Cleanup
```bash
# Remove all containers, images, and files
./deploy-remote.sh --cleanup 116.118.48.143
```

#### 2. Service Management
```bash
# SSH into server for manual management
ssh -i ~/.ssh/default root@116.118.48.143

# Check service status
cd /opt/katacore
docker compose ps

# View logs
docker compose logs -f

# Restart services
docker compose restart
```

---

## üîç Troubleshooting

### Common Issues

#### 1. SSH Connection Failed
```bash
# Test SSH connection
./deploy-remote.sh --help  # Verify script syntax

# Manual SSH test
ssh -i ~/.ssh/your-key user@server-ip

# Check SSH key permissions
chmod 600 ~/.ssh/your-key
```

#### 2. Docker Service Issues
```bash
# SSH to server and check Docker
ssh user@server-ip
systemctl status docker
docker --version

# Restart Docker if needed
sudo systemctl restart docker
```

#### 3. Port Conflicts
```bash
# Check if ports are in use
ssh user@server-ip
netstat -tulpn | grep :3000
netstat -tulpn | grep :3001

# Stop conflicting services
docker compose down
```

#### 4. SSL Certificate Issues
```bash
# Check SSL status
ssh user@server-ip
docker compose logs nginx
certbot certificates

# Renew certificates manually
certbot renew --force-renewal
```

#### 5. Git Merge Conflicts
```bash
# If autopush merge fails
git status
git merge --abort  # Cancel merge
git pull origin main  # Update main
git merge main  # Resolve conflicts manually
```

### Debug Mode

Enable debug mode for detailed logging:

```bash
# Set debug mode
export DEBUG=1

# Run deployment with debug
./deploy-remote.sh --interactive

# Check deployment logs
ssh user@server-ip
cd /opt/katacore
docker compose logs --tail=100
```

---

## üìä Monitoring

### Health Checks

The deployment includes automatic health monitoring:

#### 1. Service URLs
```bash
# After deployment, access:
https://yourdomain.com          # Main Application
https://api.yourdomain.com      # API Backend
https://minio.yourdomain.com    # MinIO Storage
https://pgadmin.yourdomain.com  # Database Admin

# For simple deployment:
http://server-ip:3000           # Main Application
http://server-ip:3001           # API Backend
http://server-ip:9000           # MinIO Storage
http://server-ip:5050           # Database Admin
```

#### 2. System Monitoring
```bash
# SSH to server for monitoring
ssh user@server-ip

# Check all services
docker compose ps

# Monitor resource usage
docker stats

# Check logs
docker compose logs -f [service-name]
```

#### 3. Database Access
```bash
# pgAdmin Web Interface
https://pgadmin.yourdomain.com
# Login: admin@yourdomain.com
# Password: <auto-generated, check .env.prod>

# Direct PostgreSQL access
docker compose exec postgres psql -U katacore -d katacore
```

### Performance Monitoring

#### 1. Resource Usage
```bash
# Server resources
ssh user@server-ip
htop
df -h
free -m

# Docker resource usage
docker system df
docker stats
```

#### 2. Application Logs
```bash
# Application logs
docker compose logs site -f
docker compose logs api -f

# Database logs
docker compose logs postgres -f

# Nginx logs
docker compose logs nginx -f
```

---

## üîê Security Best Practices

### 1. SSH Security
- Use strong SSH keys (RSA 4096 or Ed25519)
- Disable password authentication
- Use non-standard SSH ports if needed
- Regularly rotate SSH keys

### 2. Firewall Configuration
```bash
# The deployment script automatically configures UFW:
ufw allow 22/tcp      # SSH
ufw allow 80/tcp      # HTTP
ufw allow 443/tcp     # HTTPS
ufw enable
```

### 3. SSL/TLS
- Automatic Let's Encrypt SSL certificates
- HTTPS redirect for all traffic
- Strong SSL configuration

### 4. Database Security
- Auto-generated strong passwords
- Database accessible only from containers
- Regular backup recommendations

---

## üìö Additional Resources

### Documentation Files
- `README.md` - Main project documentation
- `GETTING-STARTED.md` - Quick start guide
- `DEPLOYMENT-GUIDE.md` - Detailed deployment guide
- `docs/` - Comprehensive documentation

### Support
- GitHub Issues: Report bugs and issues
- Documentation: Detailed guides and API references
- Community: Join our community discussions

---

## üìÑ License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

---

<div align="center">

**Built with ‚ù§Ô∏è by the KataCore Team**

[üè† Home](README.md) ‚Ä¢ [üìñ Docs](docs/) ‚Ä¢ [üöÄ Quick Start](GETTING-STARTED.md)

</div>
